# Implementation Plan: Chrome拡張 v0.app Chat Preview/Demo URL Opener

**Branch**: `001-v0-app-chat` | **Date**: 2025-09-24 | **Spec**: [/specs/001-v0-app-chat/spec.md](/specs/001-v0-app-chat/spec.md)
**Input**: Feature specification from `/specs/001-v0-app-chat/spec.md`

## Execution Flow (/plan command scope)
```
1. Load feature spec from Input path
2. Fill Technical Context (scan for NEEDS CLARIFICATION)
3. Fill the Constitution Check section based on the constitution
4. Evaluate Constitution Check (Initial)
5. Execute Phase 0 → research.md (collect decisions for unknowns)
6. Execute Phase 1 → data-model.md, quickstart.md, contracts/
7. Re-evaluate Constitution Check (Post-Design)
8. Plan Phase 2 (task generation approach only)
9. STOP (ready for /tasks)
```

## Summary
Browser extension that accelerates iterative UI review by extracting the latest `preview-` iframe origin in a v0.app chat, transforming it to a `demo-` URL, and opening it instantly (or via selectable list). Provides retries, duplicate handling, and performance (<300ms) + privacy (no data exfiltration) guarantees.

## Technical Context
**Language/Version**: TypeScript (ES2022) + React 18  
**Primary Dependencies**: @crxjs/vite-plugin (MV3 bundling), Vite, React, Tailwind CSS v4 + @tailwindcss/vite, ESLint, Vitest for tests  
**Storage**: Chrome extension storage (sync for preferences, local fallback) [RESEARCH]  
**Testing**: Vitest + @testing-library/react for popup/unit; playwright (future) for E2E [RESEARCH SCOPE]  
**Target Platform**: Chromium (Chrome latest), Manifest V3  
**Project Type**: single (extension mono workspace)  
**Performance Goals**: <300ms action latency for ≤50 messages & ≤5 iframes; <50ms popup render; bundle popup <150KB gzip [RESEARCH: baselines]  
**Constraints**: Must not access external network except opening target URL; zero PII persistence; deterministic ordering; coverage ≥90% changed lines (Constitution Principle II)  
**Scale/Scope**: Single popup view, one content script, background service worker, options page (if required)  

### Outstanding Unknowns (Converted to Research Tasks)
1. Duplicate consolidation display text & UX wording.
2. Storage choice finalization (sync vs local) & quota impact.
3. Keyboard shortcut default (avoid conflicts) & localization.
4. Popup URL list UI spec (truncate length, tooltip vs copy button).
5. External configurable pattern mechanism feasibility (options page or static JSON).
6. Debounce threshold adjustability & allowed range.
7. Background tab behavior (focus vs notification badge).
8. Accessiblity requirements (ARIA roles, keyboard navigation) [ADDED].
9. Security review: ensure content script isolation & CSP alignment.

## Constitution Check (Initial)
| Principle | Compliance Plan | Risk | Mitigation |
|-----------|-----------------|------|------------|
| I (Quality) | ESLint + TypeScript strict; no dead code; small modules | Medium (initial scaffolding sprawl) | Enforce size limit per file, review gating |
| II (Test-First) | Write tests for URL extraction, retry logic, duplicate filtering BEFORE implementation | Low | Scaffold failing tests first |
| III (UX Consistency) | Deterministic ordering, documented popup style guide in quickstart | Medium (UI spec unknowns) | Research tasks -> finalize before implementation |
| IV (Performance) | Micro-benchmark extraction <300ms, measure DOM query count | Low | Add performance test harness | 
| V (Observability) | Structured console logs with prefix; change summary in PR | Low | Lint rule for console usage wrappers |

Initial Gate Result: PASS (all risks have mitigation tasks in research).

## Project Structure

### Documentation (this feature)
```
specs/001-v0-app-chat/
├── plan.md
├── research.md          # Phase 0 output (/plan command)
├── data-model.md        # Phase 1 output (/plan command)
├── quickstart.md        # Phase 1 output (/plan command)
├── contracts/           # (Minimal interface contracts: extension surfaces)
└── tasks.md             # (Generated by /tasks, not now)
```

### Source Code (repository root)
```
extension/
├── src/
│   ├── content/
│   │   └── extractPreview.ts
│   ├── background/
│   │   └── serviceWorker.ts
│   ├── popup/
│   │   ├── App.tsx
│   │   └── components/
│   ├── options/
│   │   └── OptionsApp.tsx (conditional)
│   ├── styles/
│   │   └── index.css
│   └── lib/
│       └── urlLogic.ts
├── tests/
│   ├── unit/
│   │   └── urlLogic.test.ts
│   ├── integration/
│   │   └── popupInteraction.test.ts
│   └── performance/
│       └── extraction.bench.ts
└── manifest.config.ts
```

**Structure Decision**: Single project (extension) – Option 1 adapted; no multi-tier backend.

## Phase 0: Outline & Research (Completed)
See `research.md`. Unknowns documented and pending decisions table prepared.

## Phase 1: Design & Contracts (Completed)
Artifacts generated: `data-model.md`, `quickstart.md`, `contracts/messaging.md` (interface messaging schema). Test scaffolding will be created during tasks phase.

## Phase 2: Task Planning Approach
Strategy:
- Each entity -> model/interface definition test first
- Each user story -> integration test (popup selection, open latest)
- Performance test (extraction baseline) before optimization
- Parallelization: independent test files (P) vs shared manifest config (sequential)
Estimated Output: ~25 tasks (setup, tests, logic, popup UI, perf harness, preferences, accessibility, polishing).

## Phase 3+: Future Implementation
(Deferred to /tasks and later execution.)

## Complexity Tracking
| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|--------------------------------------|
| Additional perf test harness | Early regression detect | Manual timing fragile |
| Options page (tentative) | User control of patterns/debounce | Hard-coded config reduces flexibility |

## Progress Tracking
**Phase Status**:
- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [ ] Phase 2: Task planning complete (/plan command - describe approach only)
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:
- [x] Initial Constitution Check: PASS
- [ ] Post-Design Constitution Check: PASS
- [ ] All NEEDS CLARIFICATION resolved (will be resolved in research decisions PR)
- [x] Complexity deviations documented

---
*Based on Constitution v1.0.0 - See `/memory/constitution.md`*
